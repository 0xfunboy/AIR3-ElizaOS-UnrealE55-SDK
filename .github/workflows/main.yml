name: Build and Release Unreal Plugin

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

jobs:
  check-version:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Extract version from .uplugin
        id: version
        run: |
          $plugin = Get-Content "ConvAI.uplugin" | ConvertFrom-Json
          $plugin_version = $plugin.VersionName
          echo "::set-output name=version_name::$plugin_version"
        shell: powershell

      - name: Check if release exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $release_name = "Convai Unreal Engine SDK Version ${{ steps.version.outputs.version_name }}"
          $latest_release = gh release list --limit 100 | Select-String $release_name
          if ($latest_release) {
            Write-Host "Release for $release_name already exists. Skipping build."
            exit 0
          } else {
            Write-Host "New release. Proceeding with the build."
          }
        shell: powershell

  build-and-package:
    needs: check-version
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Define paths
        id: paths
        run: |
          $repo_name = "${{ github.event.repository.name }}"
          $ue_root = "E:/Software"
          $output_root = "E:/Output/${repo_name}_Binaries"
          $plugin_path = "${{ github.workspace }}/ConvAI.uplugin"
          echo "::set-output name=ue_root::$ue_root"
          echo "::set-output name=output_root::$output_root"
          echo "::set-output name=plugin_path::$plugin_path"
        shell: powershell

      - name: Extract and Copy Dependencies
        run: |
          try {
            $dependencies_dir = "E:/Dependencies"
            $plugin_dir = "${{ github.workspace }}"
            $content_zip = "$dependencies_dir/Content.zip"
            $thirdparty_zip = "$dependencies_dir/ThirdParty.zip"
            $plugin_content_dir = "$plugin_dir/Content"
            $plugin_thirdparty_dir = "$plugin_dir/Source/ThirdParty"
            if (Test-Path $plugin_content_dir) {
                Remove-Item -Recurse -Force $plugin_content_dir
            }
            if (Test-Path $plugin_thirdparty_dir) {
                Remove-Item -Recurse -Force $plugin_thirdparty_dir
            }
            Expand-Archive -Path $content_zip -DestinationPath $plugin_dir
            Expand-Archive -Path $thirdparty_zip -DestinationPath "$plugin_dir/Source"
            Write-Host "Dependencies extracted and copied successfully."
          } catch {
            Write-Host "Failed to extract and copy dependencies. Error: $_"
            exit 1
          }
        shell: powershell

      - name: Build and package for Unreal versions 5.0 to 5.4
        run: |
          try {
            $versions = @()
            foreach ($version in $versions) {
                $ue_version_path = "${{ steps.paths.outputs.ue_root }}/UE_$version"
                $output_path = "${{ steps.paths.outputs.output_root }}/V$version/Convai"
                if (Test-Path $output_path) {
                    Remove-Item -Recurse -Force -Path "$output_path/*"
                } else {
                    New-Item -Path $output_path -ItemType Directory
                }
                Write-Host "Starting packaging for UE_$version..."
                $uat_path = "$ue_version_path/Engine/Build/BatchFiles/RunUAT.bat"
                & $uat_path BuildPlugin -Plugin="${{ steps.paths.outputs.plugin_path }}" -TargetPlatforms=Win64 -Package="$output_path" -Rocket -Marketplace
                if ($LASTEXITCODE -ne 0) {
                    Write-Host "Packaging failed for UE_$version. Exit code: $LASTEXITCODE"
                    exit $LASTEXITCODE
                }
                Write-Host "Packaged for UE_$version at $output_path"
            }
          } catch {
            Write-Host "Packaging failed for Unreal Engine version $version. Error: $_"
            exit 1
          }
        shell: powershell

      - name: Test packaging for Android UE 5.4
        run: |
          try {
            $ue_version_path = "${{ steps.paths.outputs.ue_root }}/UE_5.4"
            $output_path = "${{ steps.paths.outputs.output_root }}/V5.4"
            $test_project_path = "E:/Software/TestProject"
            $plugin_folder = "$test_project_path/Plugins"
            if (Test-Path $plugin_folder) {
                Remove-Item -Recurse -Force $plugin_folder
            }
            New-Item -Path $plugin_folder -ItemType Directory
            Copy-Item -Recurse -Force "$output_path/Convai" $plugin_folder
            Write-Host "Copied the plugin to the TestProject."
            $uat_path = "$ue_version_path/Engine/Build/BatchFiles/RunUAT.bat"
            Write-Host "Starting project packaging for Android..."

            & $uat_path BuildCookRun `
            -project="$test_project_path/TestProject.uproject" `
            -noP4 -utf8output -platform=Android -targetplatform=Android -clientconfig=Shipping -cook -stage -package -compressed -pak `
            -build -prereqs -distribution -archive `
            -archivedirectory="$test_project_path/Android" `
            -target=TestProject -ddc=InstalledDerivedDataBackendGraph -installed

            if ($LASTEXITCODE -ne 0) {
                Write-Host "Android packaging failed. Exit code: $LASTEXITCODE"
                exit $LASTEXITCODE
            }
            Write-Host "Project packaging completed successfully for Android"
          } catch {
            Write-Host "Project packaging failed for Android. Error: $_"
            exit 1
          }
        shell: powershell


      - name: Test packaging for Windows UE 5.4
        run: |
          try {
            $ue_version_path = "${{ steps.paths.outputs.ue_root }}/UE_5.4"
            $output_path = "${{ steps.paths.outputs.output_root }}/V5.4"
            $test_project_path = "E:/Software/TestProject"
            $plugin_folder = "$test_project_path/Plugins"
            if (Test-Path $plugin_folder) {
                Remove-Item -Recurse -Force $plugin_folder
            }
            New-Item -Path $plugin_folder -ItemType Directory
            Copy-Item -Recurse -Force "$output_path/Convai" $plugin_folder
            Write-Host "Copied the plugin to the TestProject."
            $uat_path = "$ue_version_path/Engine/Build/BatchFiles/RunUAT.bat"
            Write-Host "Starting project packaging for Unreal 5.4..."
            & $uat_path BuildCookRun `
            -project="$test_project_path/TestProject.uproject" `
            -noP4 -utf8output -platform=Win64 -clientconfig=Shipping -cook -stage -package -compressed -pak `
            -build -prereqs -distribution -archive `
            -archivedirectory="$test_project_path/Windows"
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Packaging failed for UE_$version. Exit code: $LASTEXITCODE"
                exit $LASTEXITCODE
            }
            Write-Host "Project packaging completed successfully for Unreal 5.4"
          } catch {
            Write-Host "Project packaging failed for Unreal Engine 5.4. Error: $_"
            exit 1
          }
        shell: powershell

      - name: Zip Plugin for each version
        run: |
          try {
            $versions = @("5.4")
            foreach ($version in $versions) {
                $output_path = "${{ steps.paths.outputs.output_root }}/V$version"
                Compress-Archive -Path "$output_path" -DestinationPath "$output_path.zip"
                Write-Host "Zipped plugin for UE$version at $output_path.zip"
            }
          } catch {
            Write-Host "Zipping failed. Error: $_"
            exit 1
          }
        shell: powershell

  compress-and-release:
    needs: build-and-package
    runs-on: self-hosted
    steps:
      - name: Extract release notes
        id: extract_notes
        run: |
          $version = "${{ steps.version.outputs.version_name }}"
          $changelog = Get-Content "CHANGELOG.md"
          $notes = $changelog -split "\r?\n" | Select-String -Pattern "^# Release $version" -Context 0,10 | ForEach-Object { $_.Context.PostContext }
          $notes = $notes -join "`n"
          echo "::set-output name=release_notes::$notes"
        shell: powershell

      - name: Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version_name }}
          release_name: "Convai Unreal Engine SDK Version ${{ steps.version.outputs.version_name }}"
          body: ${{ steps.extract_notes.outputs.release_notes }}
          files: |
            E:/Output/${{ github.event.repository.name }}_Binaries/V5.4.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
